var e=Object.defineProperty,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(t,n,s)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s,r=(e,r)=>{for(var i in r||(r={}))n.call(r,i)&&a(e,i,r[i]);if(t)for(var i of t(r))s.call(r,i)&&a(e,i,r[i]);return e};import{J as i,R as o,d as l,o as u,E as c,F as d,$ as f,s as p,n as b,t as v,x as m,M as g,z as h,j}from"./vendor.3b3f849b.js";import{I as O}from"./Input.2767a10d.js";import{b as y,m as E,h as V}from"./util.cb618057.js";import"./index.f7e44da3.js";function $(e){return e}$.required=(e=[void 0,""])=>(t,n,{fieldName:s})=>{let a;return e.some((e=>{if("function"==typeof e){const n=e(t);n&&(a=n)}else t===e&&(a=`${s} cannot be ${JSON.stringify(e)}`)})),{passed:void 0===a,errors:a?[a]:[]}},$.range=(e,t,n,s)=>(a,r,{fieldName:o})=>(i(!isNaN(a),`${o} is not a number, cannot use range rule to validate.`),void 0!==e&&(n?a<=e:a<e)?{errors:[`${o} cannot be smaller than ${e}`]}:void 0!==t&&(s?a>=t:a>t)?{errors:[`${o} cannot be larger than ${t}`]}:{passed:!0});function k(e,a,r){const o={},u=[],c=[];r.forEach((({createField:a,smartValue:r})=>{if(r&&c.push(r),a){const r=a(e),{props:l}=r,c=((e,a)=>{var r={};for(var i in e)n.call(e,i)&&a.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&t)for(var i of t(e))a.indexOf(i)<0&&s.call(e,i)&&(r[i]=e[i]);return r})(r,["props"]);i(!V(Object.keys(o),Object.keys(c)),`key conflict detected: ${Object.keys(o).join(",")}, ${Object.keys(c).join(",")}`),Object.assign(o,c),l&&u.push(l)}}));const d=p((t=>{const n=e in a;return l((()=>{n||(a[e]=t.defaultValue),n||c.forEach((n=>n(e,t)))})),g(a)[e]}));return new Proxy({},{get:(t,n)=>"props"===n?e=>{const t={value:d};return u.forEach((n=>{const s="function"==typeof n?n(e):n;Object.entries(s).forEach((([e,n])=>{const s=e in t;i(!(s&&("function"!=typeof n||"function"!=typeof t[e])),`${e} is not function, cannot chain`),t[e]=s?y(t[e],n):n}))})),t}:"value"===n?a[e]:o[n]})}function S(...e){return function(t){const{getInitialValues:n=(()=>({}))}=t,s=o(n()),a=e=>{l((()=>{Object.entries(e).forEach((([e,t])=>{i(e in s,`${e} not exist. Keys: ${Object.keys(s).join(",")}`),"object"!=typeof s[e]?s[e]=t:b(s[e],t)}))}))},r=e.map((e=>e(t,s,a))),u={fields:new Proxy({},{get:(e,t)=>(e[t]||l((()=>{e[t]=k(t,s,r)})),e[t])}),setValues:a};return r.forEach((e=>{if(!e.output)return;const t="function"==typeof e.output?e.output(u):e.output;Object.assign(u,t)})),u}}const N=S((function({getInitialValues:e=(()=>({}))},t,n){const s=e(),a={};return{smartValue(e,t){e in s||(a[e]=t)},output:{reset(){const t=e();Object.entries(a).forEach((([e,n])=>{t[e]=n.defaultValue})),n(t)}}}}),(function({getInitialValues:e=(()=>({})),isEqual:t={}},n){const s=e(),a=(e,n,s)=>void 0===n||void 0===s||(t[e]?t(n,s):"object"!=typeof n||"object"!=typeof s?n===s:v(n,s));return{smartValue:(e,t)=>{e in s||(s[e]=u(t.defaultValue,!0))},createField:e=>({changed:c((()=>!a(e,s[e],n[e])))}),output:{isChanged:c((()=>Object.entries(s).some((([e,t])=>!a(e,t,n[e])))))}}}),(function({scheme:e},t){if(!e)return{};const n=(n,{value:o},{value:u},c=[],d=!1)=>{const f=m(u)?o.value:o,p=e[n];p&&l((()=>{const e={},o={};Object.entries(p).forEach((([t,n])=>{c.length&&!c.includes(t)||("AsyncFunction"===n.constructor.name?o[t]=n:e[t]=n)}));let d=!1;for(let r in e){const i=(0,e[r])(f,u,{fieldName:n,values:t});a[n][r]=!0===i.passed,s[n][r].splice(0,s[n][r].length,...i.passed?[]:i.errors),d=!0!==i.passed}d||Object.entries(o).forEach((([e,o])=>{if(c.length&&!c.includes(e))return;const d=o(f,u,{fieldName:n,values:t});r[n][e]="pending",d.then((({passed:t,errors:o})=>{i(!!t||o&&o.length,`failed rule ${e} must have errors in result.`),l((()=>{r[n][e]="none",a[n][e]=t,s[n][e].splice(0,s[n][e].length,...t?[]:o)}))})).catch((()=>{r[n][e]="error"}))}))}))},s=o({}),a=o({}),r=o({});return{state:{errorsByFieldName:s,validationResultByFieldName:a},createField:t=>{t in s||(s[t]=E(e[t],(()=>[]))),t in a||(a[t]=E(e[t],(()=>{}))),t in r||(r[t]=E(e[t],(()=>{})));const i=(...e)=>(s,a)=>n(t,s,a,e),o=e[t];return Object.keys(o).forEach((e=>{i[e]=(s,a)=>n(t,s,a,e)})),{errorsByRule:s[t],errors:d((()=>[].concat(...Object.values(s[t])))),validateStatus:r[t],isValidating:c((()=>Object.values(r[t]).some((e=>"pending"===e)))),validate:i,isValid:c((()=>Object.values(a[t]).every((e=>!0===e))))}},output:{isValid:c((()=>{let e=!1;for(let t of Object.values(a))for(let n of Object.values(t)){if(!1===n)return!1;void 0===n&&(e=!0)}return!e||void 0})),hasError:c((()=>Object.values(s).some((e=>Object.values(e).some((e=>e.length)))))),validate(){l((()=>{Object.entries(t).forEach((([e,t])=>{n(e,{value:t},{value:t},[],!0)}))}))},resetValidation(){l((()=>{Object.keys(a).forEach((e=>{a[e]=void 0})),Object.keys(r).forEach((e=>{r[e]=void 0})),Object.values(s).forEach((e=>Object.values(e).forEach((e=>e.splice(0)))))}))}}}}),(function({submit:e},t){const n=f("none"),s=c((()=>"pending"===n.value));return{output:{submit(){const s=e(t);s instanceof Promise&&(n.value="pending",s.then((()=>{n.value="success"})).catch((()=>{n.value="error"})))},submitStatus:n,isSubmitting:s}}}));function F(){const e={name:{required:$.required()},age:{required:$.required(),range:$.range(1,24)}},t=N({getInitialValues:()=>({age:"26"}),scheme:e,submit:e=>new Promise((e=>{setTimeout(e,1e3)}))});return j("div",null,j("div",null,j("span",null,"姓名"),j(O,r({},t.fields.name.props())),j("span",null,(()=>t.fields.name.changed.value?"*":"")),j("span",null,(()=>!1===t.fields.name.isValid.value?t.fields.name.errors[0]:""))),j("div",null,j("span",null,"年龄"),j(O,r({},t.fields.age.props())),j("span",null,(()=>t.fields.age.changed.value?"*":"")),j("span",null,(()=>!1===t.fields.age.isValid.value?t.fields.age.errors[0]:""))),j("div",null,j("button",{onClick:t.submit,disabled:t.isSubmitting},(()=>t.isSubmitting.value?"提交中":"提交")),j("button",{onClick:()=>{t.reset(),t.resetValidation()},disabled:t.isSubmitting},"重置"),j("button",{onClick:t.validate,disabled:t.isSubmitting},"校验")))}N.simpleScheme=$,N.createUseForm=S,h(j(F,null),document.getElementById("root"));
